name: release-main

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: release-main-publish
  cancel-in-progress: false

jobs:
  verify:
    name: verify
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Checkout
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5.0.1

      - name: Install Rust
        uses: dtolnay/rust-toolchain@e97e2d8cc328f1b50210efc529dca0028893a2d9 # v1
        with:
          toolchain: stable

      - name: Cache cargo
        uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2.8.2

      - name: Format
        run: cargo fmt --all --check

      - name: Clippy
        run: cargo clippy --all-targets --all-features -- -D warnings

      - name: Offline tests
        run: cargo test -- --skip live_

  publish:
    name: publish
    runs-on: ubuntu-latest
    needs: verify
    timeout-minutes: 20
    permissions:
      contents: write
      id-token: write
    steps:
      - name: Checkout
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5.0.1
        with:
          fetch-depth: 0

      - name: Install Rust
        uses: dtolnay/rust-toolchain@e97e2d8cc328f1b50210efc529dca0028893a2d9 # v1
        with:
          toolchain: stable

      - name: Cache cargo
        uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2.8.2

      - name: Compute CI version
        id: version
        shell: bash
        run: |
          set -euo pipefail

          BASE_VERSION="$(sed -nE 's/^version = "([^"]+)"$/\1/p' Cargo.toml | head -n 1)"
          if [[ -z "${BASE_VERSION}" ]]; then
            echo "Unable to read package version from Cargo.toml" >&2
            exit 1
          fi

          if [[ "${BASE_VERSION}" =~ ^([0-9]+\.[0-9]+\.[0-9]+)([-+].*)?$ ]]; then
            BASE_CORE="${BASH_REMATCH[1]}"
          else
            echo "Package version '${BASE_VERSION}' is not semver-compatible" >&2
            exit 1
          fi

          SHORT_SHA="${GITHUB_SHA::7}"
          NEW_VERSION="${BASE_CORE}-main.${GITHUB_RUN_NUMBER}.${GITHUB_RUN_ATTEMPT}.${SHORT_SHA}"

          sed -E -i '0,/^version = ".*"$/s//version = "'"${NEW_VERSION}"'"/' Cargo.toml

          echo "new_version=${NEW_VERSION}" >> "${GITHUB_OUTPUT}"
          echo "Generated publish version: ${NEW_VERSION}"

      - name: Authenticate to crates.io
        id: crates_auth
        uses: rust-lang/crates-io-auth-action@b7e9a28eded4986ec6b1fa40eeee8f8f165559ec # v1.0.3

      - name: Publish to crates.io
        run: cargo publish --allow-dirty --token "${{ steps.crates_auth.outputs.token }}"

      - name: Create GitHub release
        id: github_release
        env:
          GH_TOKEN: ${{ github.token }}
        shell: bash
        run: |
          set -euo pipefail

          VERSION="${{ steps.version.outputs.new_version }}"
          TAG="v${VERSION}"
          TITLE="${TAG}"
          NOTES="$(cat <<EOF
          Published \`codex-brave-web-search\` \`${VERSION}\` to crates.io.

          Install:
          \`cargo install codex-brave-web-search --version ${VERSION}\`
          EOF
          )"

          if gh release view "${TAG}" >/dev/null 2>&1; then
            gh release edit "${TAG}" --title "${TITLE}" --notes "${NOTES}" --prerelease
          else
            gh release create "${TAG}" --title "${TITLE}" --notes "${NOTES}" --prerelease --target "${GITHUB_SHA}"
          fi

          RELEASE_URL="$(gh release view "${TAG}" --json url --jq '.url')"
          echo "release_tag=${TAG}" >> "${GITHUB_OUTPUT}"
          echo "release_url=${RELEASE_URL}" >> "${GITHUB_OUTPUT}"

      - name: Publish summary
        run: |
          {
            echo "### Published crate version"
            echo ""
            echo "\`${{ steps.version.outputs.new_version }}\`"
            echo ""
            echo "Install command:"
            echo "\`cargo install codex-brave-web-search --version ${{ steps.version.outputs.new_version }}\`"
            echo ""
            echo "GitHub release:"
            echo "${{ steps.github_release.outputs.release_url }}"
          } >> "${GITHUB_STEP_SUMMARY}"
