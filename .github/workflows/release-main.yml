name: release-main

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: release-main-publish
  cancel-in-progress: false

jobs:
  verify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2

      - name: Format
        run: cargo fmt --all --check

      - name: Clippy
        run: cargo clippy --all-targets --all-features -- -D warnings

      - name: Offline tests
        run: cargo test -- --skip live_

  publish:
    runs-on: ubuntu-latest
    needs: verify
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2

      - name: Compute CI version
        id: version
        shell: bash
        run: |
          set -euo pipefail

          BASE_VERSION="$(sed -nE 's/^version = "([^"]+)"$/\1/p' Cargo.toml | head -n 1)"
          if [[ -z "${BASE_VERSION}" ]]; then
            echo "Unable to read package version from Cargo.toml" >&2
            exit 1
          fi

          if [[ "${BASE_VERSION}" =~ ^([0-9]+\.[0-9]+\.[0-9]+)([-+].*)?$ ]]; then
            BASE_CORE="${BASH_REMATCH[1]}"
          else
            echo "Package version '${BASE_VERSION}' is not semver-compatible" >&2
            exit 1
          fi

          SHORT_SHA="${GITHUB_SHA::7}"
          NEW_VERSION="${BASE_CORE}-main.${GITHUB_RUN_NUMBER}.${GITHUB_RUN_ATTEMPT}.${SHORT_SHA}"

          sed -E -i '0,/^version = ".*"$/s//version = "'"${NEW_VERSION}"'"/' Cargo.toml

          echo "new_version=${NEW_VERSION}" >> "${GITHUB_OUTPUT}"
          echo "Generated publish version: ${NEW_VERSION}"

      - name: Publish to crates.io
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
        run: cargo publish --allow-dirty --token "${CARGO_REGISTRY_TOKEN}"

      - name: Create GitHub release
        id: github_release
        env:
          GH_TOKEN: ${{ github.token }}
        shell: bash
        run: |
          set -euo pipefail

          VERSION="${{ steps.version.outputs.new_version }}"
          TAG="v${VERSION}"
          TITLE="${TAG}"
          NOTES="$(cat <<EOF
          Published \`codex-brave-web-search\` \`${VERSION}\` to crates.io.

          Install:
          \`cargo install codex-brave-web-search --version ${VERSION}\`
          EOF
          )"

          if gh release view "${TAG}" >/dev/null 2>&1; then
            gh release edit "${TAG}" --title "${TITLE}" --notes "${NOTES}" --prerelease
          else
            gh release create "${TAG}" --title "${TITLE}" --notes "${NOTES}" --prerelease --target "${GITHUB_SHA}"
          fi

          RELEASE_URL="$(gh release view "${TAG}" --json url --jq '.url')"
          echo "release_tag=${TAG}" >> "${GITHUB_OUTPUT}"
          echo "release_url=${RELEASE_URL}" >> "${GITHUB_OUTPUT}"

      - name: Publish summary
        run: |
          {
            echo "### Published crate version"
            echo ""
            echo "\`${{ steps.version.outputs.new_version }}\`"
            echo ""
            echo "Install command:"
            echo "\`cargo install codex-brave-web-search --version ${{ steps.version.outputs.new_version }}\`"
            echo ""
            echo "GitHub release:"
            echo "${{ steps.github_release.outputs.release_url }}"
          } >> "${GITHUB_STEP_SUMMARY}"
